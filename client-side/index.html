<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App Test</title>
    <style>
        .hidden {
            display: none;
        }
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .disabled-button {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
    <link rel="stylesheet" href="./styles.css">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
</head>
<body>
    <!-- 表单部分 -->
    <div class="form-container">
        <div class="form-header">
            <h1>Weather Search</h1>
            <p>Fill out the form to get weather info!</p>
        </div>
        <form id="weatherForm" novalidate>
            <label for="street">Street</label>
            <span id="streetError" class="error-message hidden">This field is required.</span>
            <input type="text" id="street" name="street" placeholder="Enter your street">

            <label for="city">City</label>
            <span id="cityError" class="error-message hidden">This field is required.</span>
            <input type="text" id="city" name="city" placeholder="Enter your city">

            <label for="state">State</label>
            <span id="stateError" class="error-message hidden">Please select a state.</span>
            <select id="state" name="state">
                <option value="">Select your state</option>
                <option value="CA">California</option>
                <option value="TX">Texas</option>
                <!-- Add more states as needed -->
            </select>

            <div class="location-checkbox">
                <label for="useCurrentLocation">Want us to auto-detect your location? Check here</label>
                <input type="checkbox" id="useCurrentLocation" name="useCurrentLocation">
            </div>

            <div class="button-container">
                <button type="button" id="submitBtn" onclick="getWeather()" disabled>Submit</button>
                <button type="button" onclick="clearForm()">Clear</button>
            </div>
        </form>
    </div>

    <!-- 天气卡片 -->
    <div id="weatherCard" class="hidden"></div>

    <!-- 天气预报表格 -->
    <div id="weatherTable" class="hidden"></div>

    <!-- 每日天气详情 -->
    <div id="dailyWeatherDetails" class="hidden"></div>

    <!-- 天气图表部分 -->
    <div id="chartsHeader" class="hidden">
        <h2>Weather Charts</h2>
        <button id="toggleChartsBtn" onclick="toggleCharts()">
            <img id="toggleChartsImg" src="./images/point-down-512.png" alt="Show Charts">
        </button>
    </div>
    <div id="chartsContainer" class="hidden">
        <div id="temperatureRangeChart" style="width: 100%; height: 400px;"></div>
        <div id="hourlyWeatherChart" style="width: 100%; height: 400px;"></div>
    </div>

    <!-- 引入 config.js -->
    <script src="./config.js" type="module"></script>

    <!-- 主脚本 -->
    <script type="module">
        import config from './config.js';
        import weatherMap from './weatherCodes.js';

        let latitude, longitude;  
        let weatherIntervals = [];

        // Highcharts 实例引用
        let temperatureChart = null;
        let hourlyChart = null;

        // 表单元素
        const useCurrentLocationCheckbox = document.getElementById('useCurrentLocation');
        const streetInput = document.getElementById('street');
        const cityInput = document.getElementById('city');
        const stateSelect = document.getElementById('state');
        const submitBtn = document.getElementById('submitBtn');

        // 错误提示元素
        const streetError = document.getElementById('streetError');
        const cityError = document.getElementById('cityError');
        const stateError = document.getElementById('stateError');

        // 初始化表单验证
        function initializeFormValidation() {
            // 监听复选框变化
            useCurrentLocationCheckbox.addEventListener('change', validateForm);

            // 监听输入框变化
            streetInput.addEventListener('input', validateForm);
            cityInput.addEventListener('input', validateForm);
            stateSelect.addEventListener('change', validateForm);
        }

        // 表单验证函数
        function validateForm() {
            const useLocation = useCurrentLocationCheckbox.checked;
            let isValid = true;

            if (!useLocation) {
                // 验证 street
                if (streetInput.value.trim() === '') {
                    streetError.classList.remove('hidden');
                    isValid = false;
                } else {
                    streetError.classList.add('hidden');
                }

                // 验证 city
                if (cityInput.value.trim() === '') {
                    cityError.classList.remove('hidden');
                    isValid = false;
                } else {
                    cityError.classList.add('hidden');
                }

                // 验证 state
                if (stateSelect.value === '') {
                    stateError.classList.remove('hidden');
                    isValid = false;
                } else {
                    stateError.classList.add('hidden');
                }
            } else {
                // 隐藏所有错误提示
                streetError.classList.add('hidden');
                cityError.classList.add('hidden');
                stateError.classList.add('hidden');
            }

            // 启用或禁用 Submit 按钮
            if (isValid) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('disabled-button');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.add('disabled-button');
            }
        }

        // 调用初始化函数
        initializeFormValidation();

        async function getWeather() {
            const useCurrentLocation = useCurrentLocationCheckbox.checked;
            const street = streetInput.value.trim();
            const city = cityInput.value.trim();
            const state = stateSelect.value;

            let url = `${config.API_BASE_URL}/get_location`;
            const params = new URLSearchParams();

            if (useCurrentLocation) {
                params.append('use_current_location', 'true');
            } else {
                if (street) params.append('street', street);
                if (city) params.append('city', city);
                if (state) params.append('state', state);
            }

            url += `?${params.toString()}`;

            try {
                // 模拟请求数据
                const response = await fetch('./test/dailyData.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                console.log(data); // 输出获取的数据

                const weather = data.weather.data.timelines[0].intervals[0].values;
                const location = data.address;
                latitude = data.latitude;
                longitude = data.longitude;

                displayWeatherCard(location, weather);

                // 提取未来天气数据并显示在表格中
                weatherIntervals = data.weather.data.timelines[0].intervals;
                displayWeatherTable(weatherIntervals);

                // 显示 weatherCard 和 weatherTable，隐藏其他部分
                document.getElementById('weatherCard').classList.remove('hidden');
                document.getElementById('weatherTable').classList.remove('hidden');
                document.getElementById('dailyWeatherDetails').classList.add('hidden');
                
                // 确保 chartsHeader 和 chartsContainer 保持隐藏状态
                document.getElementById('chartsHeader').classList.add('hidden');
                document.getElementById('chartsContainer').classList.add('hidden');
            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
                document.getElementById('weatherCard').innerHTML = `<p>Error: ${error.message}</p>`;
                document.getElementById('weatherCard').classList.remove('hidden');
                document.getElementById('weatherTable').classList.add('hidden');
                document.getElementById('dailyWeatherDetails').classList.add('hidden');
                document.getElementById('chartsContainer').classList.add('hidden');
                document.getElementById('chartsHeader').classList.add('hidden');
                document.getElementById('toggleChartsBtn').classList.add('hidden');
            }
        }

        function displayWeatherCard(location, weather) {
            const weatherCode = weather.weatherCode;
            const status = mapWeatherCodeToStatus(weatherCode);

            const cardContent = `
                <div class="weather-card">
                    <div class="card-header">
                        <h2>${location}</h2>
                    </div>
                    <div class="card-main">
                        <div class="weather-icon">
                            <img src="${status.icon}" alt="${status.description}" width="80">
                            <p>${status.description}</p>
                        </div>
                        <div class="weather-temp">
                            <h1>${Math.round(weather.temperature)}°</h1>
                        </div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail-item">
                            <p>Humidity</p>
                            <img src="./images/humidity.png" alt="Humidity Icon" width="30">
                            <p>${weather.humidity}%</p>
                        </div>
                        <div class="weather-detail-item">
                            <p>Pressure</p>
                            <img src="./images/pressure.png" alt="Pressure Icon" width="30">
                            <p>${weather.pressureSeaLevel} inHg</p>
                        </div>
                        <div class="weather-detail-item">
                            <p>Wind Speed</p>
                            <img src="./images/wind_speed.png" alt="Wind Speed Icon" width="30">
                            <p>${weather.windSpeed} mph</p>
                        </div>
                        <div class="weather-detail-item">
                            <p>Visibility</p>
                            <img src="./images/visibility.png" alt="Visibility Icon" width="30">
                            <p>${weather.visibility || 'N/A'} mi</p>
                        </div>
                        <div class="weather-detail-item">
                            <p>Cloud Cover</p>
                            <img src="./images/cloud_cover.png" alt="Cloud Cover Icon" width="30">
                            <p>${weather.cloudCover}%</p>
                        </div>
                        <div class="weather-detail-item">
                             <p>UV Level</p>
                            <img src="./images/uv_level.png" alt="UV Level Icon" width="30">
                            <p>${weather.uvIndex}</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('weatherCard').innerHTML = cardContent;
        }

        function displayWeatherTable(weatherIntervals) {
            let tableContent = `
                <div class="table-header">
                    <div class="table-cell">Date</div>
                    <div class="table-cell">Status</div>
                    <div class="table-cell">Temp High</div>
                    <div class="table-cell">Temp Low</div>
                    <div class="table-cell">Wind Speed</div>
                </div>
            `;

            for (let interval of weatherIntervals) {
                const date = new Date(interval.startTime).toLocaleDateString('en-US', {
                    weekday: 'long', year: 'numeric', month: 'short', day: 'numeric'
                });
                const weatherCode = interval.values.weatherCode;
                const status = mapWeatherCodeToStatus(weatherCode);
                const tempHigh = interval.values.temperatureMax;
                const tempLow = interval.values.temperatureMin;
                const windSpeed = interval.values.windSpeed;

                tableContent += `
                    <div class="table-row" onclick="handleRowClick('${interval.startTime}')">
                        <div class="table-cell">${date}</div>
                        <div class="table-cell">
                            <img src="${status.icon}" alt="${status.description}" width="30">
                            <span>${status.description}</span>
                        </div>
                        <div class="table-cell">${tempHigh.toFixed(2)} °F</div>
                        <div class="table-cell">${tempLow.toFixed(2)} °F</div>
                        <div class="table-cell">${windSpeed.toFixed(2)} mph</div>
                    </div>
                `;
            }

            document.getElementById('weatherTable').innerHTML = tableContent;
        }

        async function fetchWeatherData(lat, lng) {
            if (!lat || !lng) {
                console.error('Invalid latitude or longitude:', lat, lng);
                return;  // 如果无效，直接返回
            }

            let url = `${config.API_BASE_URL}/weather_data`;
            const params = new URLSearchParams({
                latitude: lat,
                longitude: lng
            });

            try {
                // 模拟请求数据
                const response = await fetch('./test/weatherData.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                console.log('Weather Data:', data);

                renderTemperatureRangeChart(data.daily.data.timelines[0].intervals);
                renderHourlyWeatherChart(data.hourly.data.timelines[0].intervals);
            } catch (error) {
                console.error('Error fetching weather data:', error);
            }
        }

        async function handleRowClick(startTime) {
            // 获取天气数据
            await fetchWeatherData(latitude, longitude);

            const selectedInterval = weatherIntervals.find(
                (interval) => interval.startTime === startTime
            );

            console.log(selectedInterval); // 输出选中的天气数据以供调试

            if (selectedInterval) {
                const date = new Date(selectedInterval.startTime).toLocaleDateString(
                    'en-US',
                    {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                    }
                );

                const condition = mapWeatherCodeToStatus(selectedInterval.values.weatherCode);
                const precipitation = mapPrecipitationType(selectedInterval.values.precipitationType);

                const detailsContent = `
                    <h1 class="weather-details-head">Daily Weather Details</h1>
                    <div class="weather-details-card">
                        <div class="weather-summary">
                            <div>
                                <h3>${date}</h3>
                                <h2>${condition.description}</h2>
                                <h1>${selectedInterval.values.temperatureMax.toFixed(2)}°F / ${selectedInterval.values.temperatureMin.toFixed(2)}°F</h1>
                            </div>
                            <div class="weather-icon-large">
                                <img src="${condition.icon}" alt="${condition.description}" width="100">
                            </div>
                        </div>
                        <div class="weather-stats">
                            <table>
                                <tr>
                                    <td>Precipitation:</td>
                                    <td>${precipitation}</td>
                                </tr>
                                <tr>
                                    <td>Chance of Rain:</td>
                                    <td>${selectedInterval.values.precipitationProbability || 0}%</td>
                                </tr>
                                <tr>
                                    <td>Wind Speed:</td>
                                    <td>${selectedInterval.values.windSpeed} mph</td>
                                </tr>
                                <tr>
                                    <td>Humidity:</td>
                                    <td>${selectedInterval.values.humidity}%</td>
                                </tr>
                                <tr>
                                    <td>Visibility:</td>
                                    <td>${selectedInterval.values.visibility || 'N/A'} mi</td>
                                </tr>
                                <tr>
                                    <td>Sunrise/Sunset:</td>
                                    <td>${formatTime(selectedInterval.values.sunriseTime)}/${formatTime(selectedInterval.values.sunsetTime)}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('dailyWeatherDetails').innerHTML = detailsContent;

                // 显示 dailyWeatherDetails 和 chartsHeader，隐藏其他部分
                document.getElementById('weatherCard').classList.add('hidden');
                document.getElementById('weatherTable').classList.add('hidden');
                document.getElementById('dailyWeatherDetails').classList.remove('hidden');
                
                // 显示 chartsHeader，并确保 chartsContainer 保持隐藏状态
                document.getElementById('chartsHeader').classList.remove('hidden');
                document.getElementById('chartsContainer').classList.add('hidden'); // 保持隐藏
                // 确保按钮图像切换为 "Show Charts" 图标
                document.getElementById('toggleChartsImg').src = './images/point-down-512.png';
                document.getElementById('toggleChartsImg').alt = 'Show Charts';
            }
        }

        function toggleCharts() {
            const chartsContainer = document.getElementById('chartsContainer');
            const toggleImg = document.getElementById('toggleChartsImg');
            
            if (chartsContainer.classList.contains('hidden')) {
                chartsContainer.classList.remove('hidden');
                toggleImg.src = './images/point-up-512.png'; // 切换为向上箭头图标
                toggleImg.alt = 'Hide Charts';
                
                // 滚动到页面底部
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth' // 平滑滚动
                });
            } else {
                chartsContainer.classList.add('hidden');
                toggleImg.src = './images/point-down-512.png'; // 切换回向下箭头图标
                toggleImg.alt = 'Show Charts';
            }
        }

        function renderTemperatureRangeChart(dailyData) {
            // 销毁现有图表（如果存在）
            if (temperatureChart) {
                temperatureChart.destroy();
            }

            const categories = dailyData.map(data => 
                new Date(data.startTime).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
            );
            const tempRanges = dailyData.map(data => [data.values.temperatureMin, data.values.temperatureMax]);

            temperatureChart = Highcharts.chart('temperatureRangeChart', {
                chart: { type: 'arearange' },
                title: { text: 'Temperature Range (Next 5 Days)' },
                xAxis: { categories },
                yAxis: { title: { text: 'Temperature (°F)' } },
                tooltip: { shared: true },
                series: [{
                    name: 'Temperature Range',
                    data: tempRanges
                }]
            });
        }

        // 渲染每小时天气图表
        function renderHourlyWeatherChart(hourlyData) {
            // 销毁现有图表（如果存在）
            if (hourlyChart) {
                hourlyChart.destroy();
            }

            // 确保 hourlyData 是数组
            if (!Array.isArray(hourlyData)) {
                console.error('hourlyData should be an array of interval data.');
                return;
            }

            // 转换数据为 [timestamp, value] 格式
            const temperatureSeries = hourlyData.map(data => [
                new Date(data.startTime).getTime(),
                data.values.temperature
            ]);
            const humiditySeries = hourlyData.map(data => [
                new Date(data.startTime).getTime(),
                data.values.humidity
            ]);
            const pressureSeries = hourlyData.map(data => [
                new Date(data.startTime).getTime(),
                data.values.pressureSeaLevel
            ]);

            hourlyChart = Highcharts.chart('hourlyWeatherChart', {
                chart: {
                    zoomType: 'x'
                },
                title: {
                    text: 'Hourly Weather Forecast (Next 5 Days)'
                },
                xAxis: [{
                    type: 'datetime',
                    // Bottom x-axis: show time (6, 12, 18, 00 hours)
                    tickInterval: 6 * 3600 * 1000, // 每6小时一个刻度
                    labels: {
                        format: '{value:%H:%M}',
                        align: 'center'
                    },
                    title: { text: 'Time' },
                    gridLineWidth: 1,
                    // Positioned at bottom
                    opposite: false
                }, {
                    type: 'datetime',
                    // Top x-axis: show date, only at 00 hours
                    linkedTo: 0, // Linked to bottom x-axis
                    tickInterval: 24 * 3600 * 1000, // 每天一个刻度
                    labels: {
                        format: '{value:%b %d}',
                        align: 'center',
                        rotation: 0,
                        style: {
                            color: 'black' // 设置颜色为黑色
                        }
                    },
                    title: { text: 'Date' },
                    opposite: true,
                    gridLineWidth: 0
                }],
                yAxis: [{
                    // Temperature Y-axis (left)
                    title: { text: 'Temperature (°F)' },
                    min: 0, // 从0°F开始
                    max: 105,
                    tickPositioner: function () {
                        let positions = [];
                        for (let i = this.min; i <= this.max; i += 7) {
                            positions.push(i);
                        }
                        return positions;
                    },
                    opposite: false
                }, {
                    // Humidity Y-axis (right) - Hide ticks and labels
                    title: { text: 'Humidity (%)', enabled: false },
                    opposite: true,
                    labels: {
                        enabled: false // 隐藏标签
                    },
                    tickWidth: 0, // 隐藏刻度线
                    gridLineWidth: 0 // 隐藏网格线
                }, {
                    // Pressure Y-axis (right) - Show only one tick for average
                    title: { text: 'Pressure (inHg)' },
                    opposite: true,
                    labels: {
                        format: '{value} inHg',
                        style: { color: '#FFB300' }
                    },
                    tickInterval: 1, // 每1 inHg一个刻度
                    gridLineWidth: 0
                }],
                tooltip: {
                    shared: true,
                    xDateFormat: '%Y-%m-%d %H:%M',
                    valueDecimals: 2
                },
                series: [{
                    name: 'Temperature',
                    type: 'line',
                    data: temperatureSeries,
                    tooltip: { valueSuffix: ' °F' },
                    color: '#FF5733',
                    dashStyle: 'Solid',
                    marker: { enabled: false },
                    zIndex: 3,
                    yAxis: 0 // 绑定到左侧温度Y轴
                }, {
                    name: 'Humidity',
                    type: 'column',
                    data: humiditySeries,
                    tooltip: { valueSuffix: ' %' },
                    yAxis: 1, // 绑定到右侧湿度Y轴
                    color: '#33B5E5',
                    pointWidth: 8,
                    zIndex: 1
                }, {
                    name: 'Pressure',
                    type: 'line',
                    data: pressureSeries,
                    tooltip: { valueSuffix: ' inHg' },
                    yAxis: 2, // 绑定到右侧压力Y轴
                    color: '#FFB300', // 更深的黄色用于压力系列
                    dashStyle: 'ShortDash',
                    marker: { enabled: false },
                    zIndex: 2
                }],
                legend: {
                    enabled: false // 隐藏图例
                },
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 800
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }
            });
        }

        function mapPrecipitationType(precipitationType) {
            const precipitationMap = {
                0: "N/A",
                1: "Rain",
                2: "Snow",
                3: "Freezing Rain",
                4: "Ice Pellets"
            };
            return precipitationMap[precipitationType] || "N/A";
        }

        function formatTime(isoTime) {
            if (!isoTime) return 'N/A';
            const date = new Date(isoTime);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
        }

        function mapWeatherCodeToStatus(weatherCode) {
            return weatherMap[weatherCode] || { description: "Unknown", icon: "" };
        }

        function clearForm() {
            useCurrentLocationCheckbox.checked = false;
            streetInput.value = '';
            cityInput.value = '';
            stateSelect.value = '';
            document.getElementById('weatherCard').innerHTML = '';
            document.getElementById('weatherTable').innerHTML = '';
            document.getElementById('dailyWeatherDetails').innerHTML = '';
            
            // 销毁现有图表实例
            if (temperatureChart) {
                temperatureChart.destroy();
                temperatureChart = null;
            }
            if (hourlyChart) {
                hourlyChart.destroy();
                hourlyChart = null;
            }

            // 隐藏所有部分
            document.getElementById('weatherCard').classList.add('hidden');
            document.getElementById('weatherTable').classList.add('hidden');
            document.getElementById('dailyWeatherDetails').classList.add('hidden');
            document.getElementById('chartsContainer').classList.add('hidden');
            document.getElementById('chartsHeader').classList.add('hidden'); // 隐藏 chartsHeader
            // 确保按钮图像重置为 "Show Charts" 图标
            document.getElementById('toggleChartsImg').src = './images/point-down-512.png';
            document.getElementById('toggleChartsImg').alt = 'Show Charts';

            // 重置表单验证状态
            streetError.classList.add('hidden');
            cityError.classList.add('hidden');
            stateError.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.classList.add('disabled-button');
        }

        window.getWeather = getWeather;
        window.clearForm = clearForm;
        window.handleRowClick = handleRowClick;
        window.toggleCharts = toggleCharts;
    </script>
</body>
</html>
